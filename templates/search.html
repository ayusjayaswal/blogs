{% extends "base.html" %}

{% block head %}
<script src="https://unpkg.com/elasticlunr@0.9.6/elasticlunr.min.js"></script>
{% endblock %}

{% block content %}
<section>
    <h2>Search</h2>
    <form id="search-form">
        <input type="search" id="search-input" placeholder="Search posts..." autocomplete="off">
        <button type="submit">Search</button>
    </form>
</section>

<section id="search-results">
    <!-- Search results will be populated here -->
</section>

<script>
let searchIndex = null;
let searchData = null;

// Load search index
fetch('{{ get_url(path="search_index.en.json") }}')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        searchIndex = elasticlunr.Index.load(data.index);
        searchData = data.pages;
        console.log('Search index loaded:', data.pages.length, 'pages');
    })
    .catch(error => {
        console.error('Error loading search index:', error);
        document.getElementById('search-results').innerHTML = '<p>Search index could not be loaded.</p>';
    });

// Search function
function performSearch(query) {
    if (!searchIndex || !query.trim()) {
        document.getElementById('search-results').innerHTML = '';
        return;
    }

    const results = searchIndex.search(query, {
        fields: {
            title: {boost: 2},
            body: {boost: 1}
        },
        expand: true
    });

    const resultsContainer = document.getElementById('search-results');
    
    if (results.length === 0) {
        resultsContainer.innerHTML = '<p>No results found.</p>';
        return;
    }

    const resultsList = results.map(result => {
        const item = searchData.find(page => page.permalink === result.ref);
        if (!item) return '';
        
        return `
            <article>
                <h3><a href="${item.permalink}">${item.title}</a></h3>
                <p>${item.body ? item.body.substring(0, 200) + '...' : ''}</p>
                <time>${item.date ? new Date(item.date).toLocaleDateString() : ''}</time>
            </article>
        `;
    }).join('');

    resultsContainer.innerHTML = `
        <h3>Search Results (${results.length})</h3>
        ${resultsList}
    `;
}

// Event listeners
document.getElementById('search-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const query = document.getElementById('search-input').value;
    performSearch(query);
});

document.getElementById('search-input').addEventListener('input', (e) => {
    const query = e.target.value;
    if (query.length > 2) {
        performSearch(query);
    } else if (query.length === 0) {
        document.getElementById('search-results').innerHTML = '';
    }
});
</script>
{% endblock %}
